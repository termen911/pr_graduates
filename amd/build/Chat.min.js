define ("local_pr_graduates/Chat",["exports","core/ajax","core/notification","core/templates","local_pr_graduates/components/loader"],function(a,b,c,d,e){"use strict";Object.defineProperty(a,"__esModule",{value:!0});a.init=void 0;b=f(b);c=f(c);d=f(d);e=f(e);function f(a){return a&&a.__esModule?a:{default:a}}function g(a,b,c,d,e,f,g){try{var h=a[f](g),i=h.value}catch(a){c(a);return}if(h.done){b(i)}else{Promise.resolve(i).then(d,e)}}function h(a){return function(){var b=this,c=arguments;return new Promise(function(d,e){var i=a.apply(b,c);function f(a){g(i,d,e,f,h,"next",a)}function h(a){g(i,d,e,f,h,"throw",a)}f(void 0)})}}function i(a,b){if(!(a instanceof b)){throw new TypeError("Cannot call a class as a function")}}function j(a,b){for(var c=0,d;c<b.length;c++){d=b[c];d.enumerable=d.enumerable||!1;d.configurable=!0;if("value"in d)d.writable=!0;Object.defineProperty(a,d.key,d)}}function k(a,b,c){if(b)j(a.prototype,b);if(c)j(a,c);return a}var l=function(){function a(b,c,d,e){i(this,a);this.timeUpdate=!1;this.lastError="";this.isLoad=!1;this.listMessagesIds=[];this.listMessages=[];this.application=b;this.objectId=d;this.sender=c;this.interval=+e;this.intervalEvent="";this.quote="";this.messages="";this.loaderUuid=new Date().getTime();this.eventSend();this.getNewMessage()}k(a,[{key:"getListMessages",value:function getListMessages(){var a=this;this.beforeGetListMessages();b.default.call([{methodname:"local_pr_graduate_chat_get_messages",args:{application:this.application,object_id:this.objectId},done:function done(b){return a.resultGetListMessages(b)},fail:c.default.exception}]);this.afterGetListMessages()}},{key:"sendMessage",value:function sendMessage(){var a=this,d={sender:this.sender,application:this.application,uid_quote:this.quote,object_id:this.objectId,message:document.getElementById("textarea-container__input").value};this.beforeSendMessage();b.default.call([{methodname:"local_pr_graduate_chat_send_message",args:d,done:function done(b){return a.resultSendMessage(b)},fail:c.default.exception}]);this.afterSendMessage()}},{key:"beforeGetListMessages",value:function beforeGetListMessages(){if(!this.isLoad){e.default.show(document.querySelector("[role=\"main\"]"),this.loaderUuid)}}},{key:"resultGetListMessages",value:function(){var a=h(regeneratorRuntime.mark(function a(b){var c;return regeneratorRuntime.wrap(function(a){while(1){switch(a.prev=a.next){case 0:if(!b.success){c=this.buildError(b)}else{c=this.buildMessage(b)}a.next=3;return this.processAllPromises(c);case 3:this.eventQuote();this.hideLoader();this.scrollToBottom();this.setLastTimeUpdate();case 7:case"end":return a.stop();}}},a,this)}));return function resultGetListMessages(){return a.apply(this,arguments)}}()},{key:"afterGetListMessages",value:function afterGetListMessages(){}},{key:"beforeSendMessage",value:function beforeSendMessage(){}},{key:"resultSendMessage",value:function(){var a=h(regeneratorRuntime.mark(function a(b){var d,e;return regeneratorRuntime.wrap(function(a){while(1){switch(a.prev=a.next){case 0:if(!b.success){e="\u041D\u0435\u0438\u0437\u0432\u0435\u0441\u0442\u043D\u0430\u044F \u043E\u0448\u0438\u0431\u043A\u0430 \u0441\u0435\u0440\u0432\u0435\u0440\u0430";if(b.errors.length){e=b.errors.join("</br>")}c.default.alert("\u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u0440\u0438 \u043E\u0442\u043F\u0440\u0430\u0432\u043A\u0435 \u0441\u043E\u043E\u0431\u0449\u0435\u043D\u0438\u044F",e,"\u0417\u0430\u043A\u0440\u044B\u0442\u044C")}else{d=this.buildMessage(b)}a.next=3;return this.processAllPromises(d);case 3:this.scrollToBottom();case 4:case"end":return a.stop();}}},a,this)}));return function resultSendMessage(){return a.apply(this,arguments)}}()},{key:"afterSendMessage",value:function afterSendMessage(){}},{key:"hideLoader",value:function hideLoader(){var a=this;if(!this.isLoad){var b=1e3;if(0<this.interval&&1e3>this.interval){b=0<this.interval}setTimeout(function(){e.default.hideByUuid(a.loaderUuid);document.getElementById("main-messaging").classList.remove("d-none");a.scrollToBottom();a.isLoad=!0},b)}}},{key:"eventQuote",value:function eventQuote(){var a=this;if(!this.isLoad){document.body.addEventListener("click",function(b){if(b.target.classList.contains("add-quote")){a.clearQuote();var e=b.target.dataset.quoteId;a.quote=e;var f=a.listMessages.filter(function(a){return e===a.uid_message}).shift();d.default.render("local_pr_graduates/components/chat/quote",f).then(function(b,c){d.default.appendNodeContents(document.getElementById("main-messaging-quote"),b,c);document.getElementById("textarea-container__quote-delete").addEventListener("click",function(){a.clearQuote()});return null}).fail(c.default.exception)}})}}},{key:"eventSend",value:function eventSend(){var a=this;document.getElementById("textarea-container__input").addEventListener("keydown",function(b){if(b.ctrlKey&&(10===b.keyCode||13===b.keyCode)){a.sendMessage();a.clearSend();a.clearQuote()}});document.getElementById("textarea-container__btn").addEventListener("click",function(){a.sendMessage();a.clearSend();a.clearQuote()})}},{key:"clearSend",value:function clearSend(){document.getElementById("textarea-container__input").value=""}},{key:"clearQuote",value:function clearQuote(){document.getElementById("main-messaging-quote").innerHTML="";this.quote=""}},{key:"buildError",value:function buildError(a){var b=[];if(a.errors.join("\n")===this.lastError){return b}this.lastError=a.errors.join("\n");a.errors.forEach(function(a){b.push(d.default.renderForPromise("local_pr_graduates/components/chat/error",{error:a}))});this.stopGetNewMessage();return b}},{key:"buildMessage",value:function buildMessage(a){var b=this,c=[],e;a.data.forEach(function(a){if(!b.listMessagesIds.includes(a.uid_message)){b.listMessagesIds.push(a.uid_message);b.listMessages.push(a);if(a.uid_quote){a.quote_message=b.messageGetQuote(a.uid_quote)}a.date=b.convertDate(a.date);if(a.sender===b.sender){e="local_pr_graduates/components/chat/incoming"}else{e="local_pr_graduates/components/chat/outgoing"}c.push(d.default.renderForPromise(e,a))}});if(document.querySelector(".main-messaging-container__error")){document.querySelector(".main-messaging-container__error").innerHTML=""}return c}},{key:"messageGetQuote",value:function messageGetQuote(a){return this.listMessages.filter(function(b){return a===b.uid_message})}},{key:"processAllPromises",value:function(){var a=h(regeneratorRuntime.mark(function a(b){return regeneratorRuntime.wrap(function(a){while(1){switch(a.prev=a.next){case 0:if(!("undefined"!=typeof b)){a.next=4;break}a.next=3;return Promise.all(b);case 3:a.sent.forEach(function(a){var b=a.html,c=a.js;d.default.appendNodeContents(document.getElementById("main-messaging-container"),b,c)});case 4:case"end":return a.stop();}}},a)}));return function processAllPromises(){return a.apply(this,arguments)}}()},{key:"scrollToBottom",value:function scrollToBottom(){var a=document.getElementById("main-messaging-container");a.scrollTop=a.scrollHeight}},{key:"getNewMessage",value:function getNewMessage(){var a=this;if(0<this.interval){this.intervalEvent=setInterval(function(){a.getListMessages()},this.interval)}else{this.stopGetNewMessage()}}},{key:"stopGetNewMessage",value:function stopGetNewMessage(){clearInterval(this.intervalEvent)}},{key:"convertDate",value:function convertDate(a){var b=new Date(a),c=10>b.getDate()?"0"+b.getDate():b.getDate(),d=10>b.getMonth()+1?"0"+(b.getMonth()+1):b.getMonth(),e=10>b.getHours()?"0"+b.getHours():b.getHours(),f=10>b.getMinutes()?"0"+b.getMinutes():b.getMinutes(),g=10>b.getSeconds()?"0"+b.getSeconds():b.getSeconds();return"".concat(c,".").concat(d,".").concat(b.getFullYear()," ").concat(e,":").concat(f,":").concat(g)}},{key:"setLastTimeUpdate",value:function setLastTimeUpdate(){document.getElementById("time-update-container").classList.remove("d-none");document.getElementById("time-update").innerHTML=" "+this.convertDate(new Date)}}]);return a}();a.init=function init(a,b,c,d){new l(a,b,c,d).getListMessages()}});
//# sourceMappingURL=Chat.min.js.map
